{
  "data": {
    "repository": {
      "issue": {
        "number": 672,
        "title": "[Feature]: Custom loss function implementation in python ",
        "body": "### Feature Request\n\nHello. I would like to have a feature, where I can pass custom function loss implemented in python instead of in julia. I'm not able to implement it in julia as it part of bigger optimization pipeline. I believe this feature can be implemented by passing python function pointer to julia and executing it from there.",
        "comments": {
          "nodes": [
            {
              "author": {
                "login": "MilesCranmer"
              },
              "body": "Maybe you could try PythonCall.jl? https://juliapy.github.io/PythonCall.jl/stable/pythoncall/ It lets you call Python functions from Julia. See https://astroautomata.com/PySR/examples/#7-julia-packages-and-types for an example of using an external Julia package in the loss function.",
              "createdAt": "2024-07-16T22:52:34Z"
            },
            {
              "author": {
                "login": "xnerhu"
              },
              "body": "> Maybe you could try PythonCall.jl? https://juliapy.github.io/PythonCall.jl/stable/pythoncall/ It lets you call Python functions from Julia. See https://astroautomata.com/PySR/examples/#7-julia-packages-and-types for an example of using an external Julia package in the loss function.\r\n\r\nIt somewhat worked thanks.\r\n\r\n```\r\nimport os\r\n\r\n\r\nos.environ[\"PYTHON_JULIACALL_THREADS\"] = \"1\"\r\nfrom datetime import datetime\r\nimport numpy as np\r\nfrom pysr import PySRRegressor\r\nfrom pysr import jl\r\n\r\nfrom julia.api import Julia\r\n\r\n\r\nx = None\r\n\r\n\r\ndef custom_loss(y_true, y_pred):\r\n    # global x\r\n    # print(y_true, y_pred, x)\r\n    # if x is None:\r\n    #     x = np.random.rand()\r\n    return float((y_true - y_pred) ** 2)\r\n\r\n\r\njl.seval(\r\n    \"\"\"\r\nimport Pkg\r\nPkg.add(\"PythonCall\")\r\n\"\"\"\r\n)\r\njl.custom_loss_function = custom_loss\r\n\r\njl.seval(\r\n    \"\"\"\r\nfunction custom_loss_wrapper(y_true, y_pred)\r\n    py_obj = PythonCall.pycall(custom_loss_function, y_true, y_pred)\r\n    return PythonCall.pyconvert(Float32, py_obj)\r\nend\r\n\"\"\"\r\n)\r\n\r\nX = np.random.rand(100, 2)\r\ny = X[:, 0] * X[:, 1] + np.random.rand(100) * 0.1\r\n\r\nmodel = PySRRegressor(\r\n    niterations=40,\r\n    binary_operators=[\"+\", \"-\", \"*\", \"/\"],\r\n    unary_operators=[\"cos\", \"exp\"],\r\n    elementwise_loss=\"custom_loss_wrapper\",\r\n)\r\n\r\nmodel.fit(X, y)\r\nprint(model)\r\npredictions = model.predict(X)\r\nprint(predictions)\r\n\r\n```\r\n\r\nThough I had to do `os.environ[\"PYTHON_JULIACALL_THREADS\"] = \"1\"` from https://github.com/MilesCranmer/PySR/issues/661\r\n\r\nbecause of\r\n\r\n```\r\n  Resolving package versions...\r\n  No Changes to `C:\\Users\\xnerhu\\.julia\\environments\\pyjuliapkg\\Project.toml`\r\n  No Changes to `C:\\Users\\xnerhu\\.julia\\environments\\pyjuliapkg\\Manifest.toml`\r\nCompiling Julia backend...\r\n\r\nPlease submit a bug report with steps to reproduce this fault, and any error messages that follow (in their entirety). Thanks.\r\nException: EXCEPTION_ACCESS_VIOLATION at 0x7ff85e1587a5 --  at 0x7ff85e1587a5 -- ION with steps to reproduce this fault, and any error messages that follow (in their entirety). Thanks.\r\nException: EXCEPTION_ACCESS_VIOLATION at 0x7ff85e163a4d -- PyObject_GC_Malloc at C:\\Python310\\python310.dll (unknown line)  \r\nnd any error messages that follow (in their entirety). Thanks.\r\nException: EXCEPTION_ACCESS_VIOLATION at 0x7ff85e1587a5 --  at 0x7ff85e1587a5 -- IONC:\\Python310\\python310.dll (unknown lin expression starting at none:0\r\n\\python310.dll (unknown line)\r\nin expression starting at none:0\r\nin expression starting at none:0\r\n\\python310.dll (unknown line)\r\nne)\r\nin expression starting at none:0\r\nin expression starting at none:0\r\n\\python310.dll (unknown line)\r\nPyEval_EvalFrameDefault at C:\\PytPyEval_EvalFrameDefault at C:\\Python310\\python310.dll (unknown line)\r\nPyFunction_Vectorcall at C:\\Python310\\python310.dll (unknown line)\r\n\r\nPyFunction_Vectorcall at C:\\Python310\\python310.dll (unknown linyFunction_Vectorcall at C:\\Python310\\python310.dll (unknown line)\r\nPyVectorcall_Call at C:\\Python310\\python310.dll (unknown line)\r\ne)\r\nPyVectorcall_Call at C:\\Python310\\python310.dll (unknown line)\r\nPyVectorcall_Call at C:\\Python310\\python310.dll (unknown line)\r\nPyObject_Call at efault at C:\\Python310\\python310.dll (unknown PyObject_Call at C:\\Python310\\python310.dll (unknown line)   \r\nwn line)\r\nPyObject_Call at C:\\Python310\\python310.dll (unknown line)\r\nPyFunction_Vectorcall at C:\\Python310\\python310.dll (unknowPyFunction_Vectorcall at C:\\Python310\\python310.dll (unknown line)\r\nPyObject_CallObject at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\C\\pointers.jl:297 [inlined]\r\nmacro expansion at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\Core\\Py.jl:132 [inlined]\r\npycallargs at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\Core\\builtins.jl:212\r\nunknown function (ip: 00000138b4d57ddf)\r\n#pycall#21 at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\Core\\builtins.jl:230\r\n#pycall#21 at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\#pycall#21 at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\Core\\builtins.jl:230\r\nnlined]\r\nined]\r\nmacro expansion at C:\\Users\\xnerhu\\.julia\\packages\\PythonCamacro expansion at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\Core\\Py.jl:132 [inlined]\r\npycallargs at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\Core\\builtins.jl:212\r\njl_apply at C:/workdir/src\\julia.h:1982 [inlined]\r\ndo_apply at C:/workdir/src\\builtins.c:768\r\ndo_apply at C:/workdir/src\\builtins.c:76pycall at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\Core\\builtins.jl:220 \r\npycall#21 at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\Core\\builtins.jl:230\r\n:297 [inlined]\r\nmacro expansion at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\Core\\Py.jl:132 [inlined]\r\npycallargs at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\Core\\builtins.jl:212\r\nunknown function (ip: 00000138b4d57ddf)\r\nages\\PythonCall\\S5MOg\\src\\Core\\builtins.jl:212\r\nunknown function (ip: 00000138b4unknown function (ip: 00000138b4d57ddf)\r\nl at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:19 [inlined]\r\n#4 at C:\\Users\\xnerhu\\.julia\\environments\\pyjuliapkg\\pyjuliapkg\\install\\share\\julia\\stdlib\\v1.10\\Statistics\\src\\Statistics.jl:187 [inlined]\r\nmapreduce_impl at .\\reduce.jl:262\r\nmapreduce_impl at .\\reduce.jl:262\r\nnments\\pyjuliapkg\\pyjuliapkg\\install\\share\\julia\\stdljl_apply at C:/workdir/src\\julia.h:1982 [inlined]\r\ndo_apply at C:/workdir/src\\builtins.c:768\r\npycall at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\Core\\builtins.jl:220\r\ncustom_loss_wrapper at .\\none:2\r\nl at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:19 [inlined]\r\n#4 at C:\\Users\\xnerhu\\.julia\\environments\\pyjuliapkg\\pyjuliapkg\\install\\share\\julia\\stdlib\\v1.10\\Statistics\\src\\Statistics.jl:187 [inlined]\r\nmapreduce_impl at .\\reduce.jl:262\r\nmapreduce_impl at .\\reduce.jl:277 [inlined]\r\n_mapreduce at .\\reduce.jl:447\r\njl_apply at C:/workdir/src\\julia.h:1982 [inlined]\r\ndo_apply at C:/workdir/src\\builtins.c:768\r\npycall at C:\\Users\\xnerhu\\.julia\\packages\\PythonCall\\S5MOg\\src\\Core\\builtins.jl:220\r\npycall at C:\\Users\\xnerhu\\.julia\\packages\\Pytho#mapreduce#821 at .\\reducedim.jl:357 [inlined]\r\nmapreduce at .\\reducedim.jl:357 [inlined]\r\n#_sum#831 at .\\reducedim.jl:1015 [inlined]\r\n_sum at .\\reducedim.jl:1015 [inlined]\r\n#sum#829 at .\\reducedim.jl:1011 [inlined]\r\nsum at .\\reducedim.jl:1011 [inlined]\r\n_mean at C:\\Users\\xnerhu\\.julia\\environments\\pyjuliapkg\\pyjuliapkg\\install\\share\\julia\\stdlib\\v1.10\\Statistics\\src\\Statistics.jl:187\r\n_mean at C:\\Users\\xnerhu\\.julia\\_mean at C:\\Users\\xnerhu\\.julia\\environments_mapreduce at .\\reduce.jl:447\r\nia\\environments\\pyjuliapkg\\pyjuliapkg\\install\\share\\julia\\stdlib\\v1.10\\Statistics\\src\\Statistics.jl:104 [inlined]\r\nmean at C:\\Users\\xnerhu\\.julia\\environments\\pyjuliapkg\\pyjuliapkg\\install\\share\\julia\\stdlib\\v1.10\\Statistics\\src\\Statistics.jl:104 [inlined]\r\n_loss at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:20\r\nunknown function (ip: 00000138b4df92cf)\r\nunknown function (ip: 00000138_mapreduce_dim at .\\reducedim.jl:365 [inlined]\r\n#mapreduce#821 at .\\reducedim.jl:357 [inlined]\r\nmapreduce at .\\reducedim.jl:357 [inlined]\r\n#_sum#831 at .\\reducedim.jl:1015 [inlined]\r\n_sum at .\\reducedim.jl:1015 [inlined]\r\n#sum#829 at .\\reducedim.jl:1011 [inlined]\r\nsum at .\\reducedim.jl:1011 [inlined]\r\n_mean at C:\\Users\\xnerhu\\.julia\\environments\\pyjuliapkg\\pyjuliapkg\\install\\share\\julia\\stdlib\\v1.10\\Statistics\\src\\Statistics.jl:187\r\n_mean at C:\\Users\\xnerhu\\.julia\\environments\\pyjuliapkg\\pyjuliapkg\\install\\share\\julia\\stdlib\\v1_mean at C:\\Users\\xnerhu\\.julia\\environments\\pyjuliapkg\\pyjuliapkg\\install\\share\\julia\\stdlib\\v1.10\\Statistics\\src\\Statistics.jl:186\r\n_eval_loss at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:67\r\n#mean#1 at C:\\Users\\xnerhu\\.julia\\environments\\pyjuliapkg\\pyjuliapkg\\install\\share\\julia\\stdlib\\v1.10\\Statistics\\src\\Statistics.jl:104 [inlined]\r\nmean at C:\\Users\\xnerhu\\.julia\\environments\\pyjuliapkg\\pyjuliapkg\\install\\share\\julia\\stdlib\\v1.10\\Statistics\\src\\Statistics.jl:104 [inlined]\r\n_loss at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:20\r\njl:105\r\n_loss at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:20\r\nunknown function (ip: 00000138b4df92cf)\r\nunknown function (ip: 00000138b4df92cf)\r\nSymbolicRegression\\FtJSD\\src\\LossFunctions.jl:20\r\njl:105\r\nStatistics\\src\\Statistics.jl:104 [inlined]\r\n]\r\nmean at C:\\Users\\xnerhu\\.julia\\environments\\pyjuliapkg\\pyjuliapkg\\install\\share\\julia\\stdlib\\v1.10\\Statistics\\src\\Statistics.jl:104 [inlined]\r\n_loss at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:20\r\nunknown function (ip: 00000138b4df92cf)\r\nSymbolicRegression\\FtJSD\\src\\LossFunctions.jl:20\r\nb\\v1.10\\Stati#score_func#5 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:164 [inlined]\r\nscore_func at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:161 [inlined]\r\n#PopMember#2 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\PopMember.jl:99\r\n#PopMember#2 at C:\\Users\\xnerhu\\.julia\\p#PopMember#2 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\PopMember.jl:99\r\n1#eval_loss#3 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:105\r\n_eval_loss at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:67\r\neval_loss at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:97 [inlined]\r\n#score_func#5 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:164 [inlined]\r\nscore_func at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:161 [inlined]\r\n#PopMember#2 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\PopMember.jl:99\r\n#PopMember#2 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\PopMember.jl:99\r\n1 [ieval_loss at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:97 [inlinPopMember at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\PopMember.jl:88 [inlined]\r\n#2 at .\\none:0 [inlined]\r\niterate at .\\generator.jl:47 [inlined]\r\nages\\SymbolicRegression\\FtJSD\\src\\PopMember.jl:88 [inlined]\r\nPopMember at C:\\Users\\xnerhu\\.julia\\paccollect at .\\array.jl:834\r\ncollect at .\\array.jl:834\r\nu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\PopMember.jl:88 [inlined]\r\n#2 at .\\none:0 [inlined]\r\niterate at .\\generator.jl:47 [inlined]\r\ncollect at .\\array.jl:834\r\n#Population#1 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\Population.jl:49 [inlined]#score_func#5 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:164 [inlined]\r\nscore_func at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\LossFunctions.jl:161 [inlined]\r\n#PopMember#2 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\PopMember.jl:99\r\n#PopMember#2 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\PopMember.jl:99\r\n1 [inlined]Population at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\Population.jl:35 [inlined]\r\nmacro expansion at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\SymbolicRegression.jl:765 [inlined]\r\n#54 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\SearchUtils.jl:116\r\n#54 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\SearchUtils.jl:116\r\n8 [inlined]\r\nPopMember at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\PopMember.jl:88 [inlined]\r\n#2 at .\\none:0 [inlined]\r\niterate at .\\generator.jl:47 [inlined]\r\ncollect at .\\array.jl:834\r\ncollect at .\\array.jl:834\r\n7 [inlined]\r\nages\\SymbolicRegression\\FtJSD\\src\\PopMember.jl:88 [inlined]\r\n:765Population at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\Population.jl:35 [inlined]\r\nmacro expansion at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\SymbolicRegression.jl:765 [inlined]\r\n#54 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\SearchUtils.jl:116\r\njfptr_YY.54_21945 at C:\\Users\\xnerhu\\.julia\\compiled\\v1.10\\SymbolicRegression\\X2eIS_JE3Mg.dll (unknown line)\r\n#Population#1 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\Population.jl:49 [inlined]\r\nPopulation at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\Population.jl:35 [inlined]\r\nmacro expansion at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\SymbolicRegression.jl:765 [inlined]\r\n#54 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\SearchUtils.jl:116\r\n#54 at C:\\Users\\xnerhu\\.julia\\packages\\SymbolicRegression\\FtJSD\\src\\SearchUtils.jl:116\r\nRegression.jl:765 [injl_apply at C:/workdir/src\\julia.h:1982 [inlined]\r\nstart_task at C:/workdir/src\\task.c:1238\r\nAllocations: 17550813 (Pool: 17526745; Big: 24068); GC: 21\r\njfptr_YY.54_21945 at C:\\Users\\xnerhu\\.julia\\compiled\\v1.10\\SymbolicRegression\\X2eIS_JE3Mg.dll (unknown line)\r\njl_apply at C:/workdir/src\\julia.h:1982 [inlined]\r\nstart_task at C:/workdir/src\\task.c:1238\r\nAllocations: 17550813 (Pool: 17526745; Big: 24068); GC: 21\r\n```\r\n\r\nalso, how can I do loss_function intead of elemenetwise_loss? I think seval needs to have explicit types in args\r\n\r\n```\r\njuliacall.JuliaError: MethodError: no method matching custom_loss_wrapper(::Node{Float32}, ::Dataset{Float32, Float32, Matrix{Float32}, Vector{Float32}, Nothing, @NamedTuple{}, Nothing, Nothing, Nothing, Nothing}, ::Options{Int64, DynamicExpressions.OperatorEnumModule.OperatorEnum, Node, false, false, nothing, StatsBase.Weights{Float64, Float64, Vector{Float64}}})\r\n```\r\n",
              "createdAt": "2024-07-17T09:12:07Z"
            },
            {
              "author": {
                "login": "xnerhu"
              },
              "body": "btw is it possible to do multivaritive prediction (multiple outpouts)?",
              "createdAt": "2024-07-17T09:24:36Z"
            }
          ],
          "pageInfo": {
            "hasNextPage": false,
            "endCursor": "Y3Vyc29yOnYyOpHOhRaS2Q=="
          }
        }
      }
    }
  }
}